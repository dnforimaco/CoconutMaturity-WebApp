
{% extends "base.html" %}
{% block content %}
<div class="detect-container">
    <!-- Instructions Section -->
    <div class="instructions-section">
        <div class="instructions-header">
            <h2>Coconut Maturity Detection</h2>
            <p class="instructions-subtitle">Upload an audio recording of coconut tapping to determine maturity level</p>
        </div>

        <div class="instructions-grid">
            <div class="instruction-card">
                <div class="instruction-icon">üì±</div>
                <h3>How to Record</h3>
                <p>Tap the coconut firmly with a stick or your knuckles and record the sound for 2-3 seconds</p>
            </div>

            <div class="instruction-card">
                <div class="instruction-icon">üéôÔ∏è</div>
                <h3>Audio Quality</h3>
                <p>Use a clear recording in a quiet environment. Supported formats: WAV, MP3, OGG</p>
            </div>

            <div class="instruction-card">
                <div class="instruction-icon">‚ö°</div>
                <h3>Quick Results</h3>
                <p>Get instant classification results with confidence levels for accurate maturity assessment</p>
            </div>
        </div>

        <div class="maturity-guide">
            <h3>Understanding Results</h3>
            <div class="maturity-types">
                <div class="maturity-type premature">
                    <span class="maturity-indicator"></span>
                    <div>
                        <strong>Premature:</strong> Needs more time (‚âà 6‚Äì9 months)
                    </div>
                </div>
                <div class="maturity-type mature">
                    <span class="maturity-indicator"></span>
                    <div>
                        <strong>Mature:</strong> Ready for harvest (‚âà 10‚Äì12 months)
                    </div>
                </div>
                <div class="maturity-type overmature">
                    <span class="maturity-indicator"></span>
                    <div>
                        <strong>Overmature:</strong> Harvested late; quality declines (12+ months)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <div class="upload-box">
            <div class="upload-header">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 24 24">
                        <path fill="#4f4949" d="M9 13V5c0-1.1.9-2 2-2h9c1.1 0 2 .9 2 2v6h-3.43l-1.28-1.74a.14.14 0 0 0-.24 0L15.06 12c-.06.06-.18.07-.24 0l-1.43-1.75a.152.152 0 0 0-.23 0l-2.11 2.66c-.08.09-.01.24.11.24h6.34V15H11c-1.11 0-2-.89-2-2m-3 9v-1H4v1H2V2h2v1h2V2h2.39C7.54 2.74 7 3.8 7 5v8c0 2.21 1.79 4 4 4h4.7c-1.03.83-1.7 2.08-1.7 3.5c0 .53.11 1.03.28 1.5zM4 7h2V5H4zm0 4h2V9H4zm0 4h2v-2H4zm2 4v-2H4v2zm17-6v2h-2v5.5a2.5 2.5 0 0 1-5 0a2.5 2.5 0 0 1 3.5-2.29V13z"/>
                    </svg>
                </div>
                <h2>Upload Audio File</h2>
                <p>Choose your coconut tapping audio recording</p>
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="multi-file-upload">
                    <div class="upload-slot" data-slot="1">
                        <div class="slot-header">
                            <span class="slot-number">Recording 1</span>
                            <span class="slot-status" id="status1">Empty</span>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" class="audioFile" name="audio_files" accept=".wav,.mp3,.ogg,.m4a" data-slot="1">
                            <div class="file-input-display">
                                <div class="file-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24"><g fill="none" stroke="#302f2f" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path fill="#302f2f" fill-opacity="0" stroke-dasharray="20" stroke-dashoffset="20" d="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"><animate attributeName="d" begin="0.5s" dur="1.5s" repeatCount="indefinite" values="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5;M12 15h2v-3h2.5l-4.5 -4.5M12 15h-2v-3h-2.5l4.5 -4.5;M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"/><animate fill="freeze" attributeName="fill-opacity" begin="0.7s" dur="0.5s" values="0;1"/><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="20;0"/></path><path stroke-dasharray="14" stroke-dashoffset="14" d="M6 19h12"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.2s" values="14;0"/></path></g></svg>
                                </div>
                                <div class="file-input-text">
                                    <p class="primary-text">Click to browse</p>
                                    <p class="secondary-text">WAV, MP3, OGG</p>
                                </div>
                            </div>
                            <div class="file-info" id="fileInfo1" style="display: none;">
                                <div class="file-details">
                                    <span class="file-name" id="fileName1"></span>
                                    <span class="file-size" id="fileSize1"></span>
                                </div>
                                <button class="remove-file" data-slot="1">‚úï</button>
                            </div>
                        </div>
                    </div>

                    <div class="upload-slot" data-slot="2">
                        <div class="slot-header">
                            <span class="slot-number">Recording 2</span>
                            <span class="slot-status" id="status2">Empty</span>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" class="audioFile" name="audio_files" accept=".wav,.mp3,.ogg,.m4a" data-slot="2">
                            <div class="file-input-display">
                                <div class="file-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24"><g fill="none" stroke="#302f2f" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path fill="#302f2f" fill-opacity="0" stroke-dasharray="20" stroke-dashoffset="20" d="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"><animate attributeName="d" begin="0.5s" dur="1.5s" repeatCount="indefinite" values="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5;M12 15h2v-3h2.5l-4.5 -4.5M12 15h-2v-3h-2.5l4.5 -4.5;M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"/><animate fill="freeze" attributeName="fill-opacity" begin="0.7s" dur="0.5s" values="0;1"/><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="20;0"/></path><path stroke-dasharray="14" stroke-dashoffset="14" d="M6 19h12"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.2s" values="14;0"/></path></g></svg>
                                </div>
                                <div class="file-input-text">
                                    <p class="primary-text">Click to browse</p>
                                    <p class="secondary-text">WAV, MP3, OGG</p>
                                </div>
                            </div>
                            <div class="file-info" id="fileInfo2" style="display: none;">
                                <div class="file-details">
                                    <span class="file-name" id="fileName2"></span>
                                    <span class="file-size" id="fileSize2"></span>
                                </div>
                                <button class="remove-file" data-slot="2">‚úï</button>
                            </div>
                        </div>
                    </div>

                    <div class="upload-slot" data-slot="3">
                        <div class="slot-header">
                            <span class="slot-number">Recording 3</span>
                            <span class="slot-status" id="status3">Empty</span>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" class="audioFile" name="audio_files" accept=".wav,.mp3,.ogg,.m4a" data-slot="3">
                            <div class="file-input-display">
                                <div class="file-input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24"><g fill="none" stroke="#302f2f" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path fill="#302f2f" fill-opacity="0" stroke-dasharray="20" stroke-dashoffset="20" d="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"><animate attributeName="d" begin="0.5s" dur="1.5s" repeatCount="indefinite" values="M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5;M12 15h2v-3h2.5l-4.5 -4.5M12 15h-2v-3h-2.5l4.5 -4.5;M12 15h2v-6h2.5l-4.5 -4.5M12 15h-2v-6h-2.5l4.5 -4.5"/><animate fill="freeze" attributeName="fill-opacity" begin="0.7s" dur="0.5s" values="0;1"/><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.4s" values="20;0"/></path><path stroke-dasharray="14" stroke-dashoffset="14" d="M6 19h12"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.5s" dur="0.2s" values="14;0"/></path></g></svg>
                                </div>
                                <div class="file-input-text">
                                    <p class="primary-text">Click to browse</p>
                                    <p class="secondary-text">WAV, MP3, OGG</p>
                                </div>
                            </div>
                            <div class="file-info" id="fileInfo3" style="display: none;">
                                <div class="file-details">
                                    <span class="file-name" id="fileName3"></span>
                                    <span class="file-size" id="fileSize3"></span>
                                </div>
                                <button class="remove-file" data-slot="3">‚úï</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="upload-actions">
                    <button type="submit" class="btn btn--primary" id="submitBtn">
                        <span class="btn-text">Analyze All Recordings</span>
                        <span class="btn-icon">üîç</span>
                    </button>
                    <button type="button" class="btn btn--secondary" id="clearAllBtn">Clear All</button>
                </div>
            </form>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Analyzing your audio recording...</p>
            </div>

            <!-- File Info -->
            <div class="file-info" id="fileInfo" style="display: none;">
                <div class="file-details">
                    <span class="file-name" id="fileName"></span>
                    <span class="file-size" id="fileSize"></span>
                </div>
                <button class="remove-file" id="removeFile">‚úï</button>
            </div>

            <!-- Result Section -->
            {% if result %}
                <div class="result-section" id="resultSection">
                    <div class="result-box
                        {% if 'Mature' in result %} mature
                        {% elif 'Premature' in result %} premature
                        {% elif 'Overmature' in result %} overmature
                        {% endif %}">
                        <div class="result-header">
                            <div class="result-icon">
                                {% if 'Mature' in result %}üå¥{% elif 'Premature' in result %}üå±{% elif 'Overmature' in result %}üçÇ{% endif %}
                            </div>
                            <h3>Classification Result</h3>
                        </div>
                        <div class="result-content">
                            <p class="result-text">{{ result }}</p>
                            <div class="confidence-meter">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: {{ confidence }}%"></div>
                                </div>
                                <span class="confidence-text">{{ confidence }}% Confidence</span>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn btn--primary" onclick="scrollToUpload()">Analyze Another</button>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Recent Analyses Section -->
        <div class="recent-analyses-section">
            <div class="recent-analyses-header">
                <h3>Recent Analyses</h3>
                <button class="btn btn--secondary" onclick="location.href='/history'">View All</button>
            </div>

            <div class="recent-analyses-list" id="recentAnalysesList">
                <!-- Recent analyses will be populated here -->
                <div class="no-analyses" id="noAnalyses">
                    <p>No recent analyses yet. Upload an audio file to get started!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Multi-file upload handling for coconut maturity detection
const form = document.getElementById("uploadForm");
const loadingState = document.getElementById("loadingState");
const submitBtn = document.getElementById("submitBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const audioFileInputs = document.querySelectorAll(".audioFile");

// Initialize file slots
let fileSlots = {
    1: { file: null, element: null },
    2: { file: null, element: null },
    3: { file: null, element: null }
};

// Initialize slot elements
document.addEventListener("DOMContentLoaded", function() {
    audioFileInputs.forEach(input => {
        const slot = parseInt(input.dataset.slot);
        fileSlots[slot].element = input;
    });
});

// File input change handlers
audioFileInputs.forEach(input => {
    input.addEventListener("change", function(e) {
        const slot = parseInt(this.dataset.slot);
        const file = e.target.files[0];

        if (file) {
            // Validate file type
            const validTypes = ['audio/wav', 'audio/mpeg', 'audio/ogg', 'audio/mp4', 'audio/mp3'];
            if (!validTypes.some(type => file.type.includes(type.split('/')[1]))) {
                showError("Please select a valid audio file (WAV, MP3, OGG, M4A)");
                this.value = "";
                return;
            }

            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showError("File size must be less than 10MB");
                this.value = "";
                return;
            }

            // Store file and update UI
            fileSlots[slot].file = file;
            displayFileInfo(slot, file);
            updateSlotStatus(slot, "ready");
        } else {
            fileSlots[slot].file = null;
            clearFileInfo(slot);
            updateSlotStatus(slot, "empty");
        }

        // Update submit button state
        updateSubmitButton();
    });
});

// Display file information for a specific slot
function displayFileInfo(slot, file) {
    const fileInfo = document.getElementById(`fileInfo${slot}`);
    const fileName = document.getElementById(`fileName${slot}`);
    const fileSize = document.getElementById(`fileSize${slot}`);
    const fileInputDisplay = fileInfo.parentElement.querySelector('.file-input-display');

    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileInfo.style.display = "flex";
    fileInputDisplay.style.display = "none";
}

// Clear file information for a specific slot
function clearFileInfo(slot) {
    const fileInfo = document.getElementById(`fileInfo${slot}`);
    const fileInputDisplay = fileInfo.parentElement.querySelector('.file-input-display');

    fileInfo.style.display = "none";
    fileInputDisplay.style.display = "flex";
}

// Update slot status
function updateSlotStatus(slot, status) {
    const statusElement = document.getElementById(`status${slot}`);
    statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    statusElement.className = `slot-status ${status}`;
}

// Update submit button based on filled slots
function updateSubmitButton() {
    const filledSlots = Object.values(fileSlots).filter(slot => slot.file !== null).length;
    // Enable button when files are cleared (0 files) or when all 3 slots are filled
    submitBtn.disabled = filledSlots > 0 && filledSlots !== 3;
}

// Remove file from slot
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-file")) {
        const slot = parseInt(e.target.dataset.slot);
        fileSlots[slot].element.value = "";
        fileSlots[slot].file = null;
        clearFileInfo(slot);
        updateSlotStatus(slot, "empty");
        updateSubmitButton();
    }
});

// Clear all files
clearAllBtn.addEventListener("click", function() {
    audioFileInputs.forEach(input => {
        const slot = parseInt(input.dataset.slot);
        input.value = "";
        fileSlots[slot].file = null;
        clearFileInfo(slot);
        updateSlotStatus(slot, "empty");
    });
    updateSubmitButton();
});

// Drag and drop functionality for each slot
document.querySelectorAll('.file-input-wrapper').forEach(wrapper => {
    const slot = parseInt(wrapper.querySelector('.audioFile').dataset.slot);

    wrapper.addEventListener("click", function(e) {
        // Only trigger file input click if clicking on the wrapper itself, not child elements
        if (e.target === this || e.target.classList.contains('file-input-display') ||
            e.target.classList.contains('file-input-icon') || e.target.classList.contains('file-input-text')) {
            e.preventDefault();
            fileSlots[slot].element.click();
        }
    });

    wrapper.addEventListener("dragover", function(e) {
        e.preventDefault();
        this.classList.add("drag-over");
    });

    wrapper.addEventListener("dragleave", function(e) {
        e.preventDefault();
        this.classList.remove("drag-over");
    });

    wrapper.addEventListener("drop", function(e) {
        e.preventDefault();
        this.classList.remove("drag-over");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileSlots[slot].element.files = files;
            fileSlots[slot].element.dispatchEvent(new Event("change"));
        }
    });
});

// Form submission with AJAX
form.addEventListener("submit", async function(e) {
    e.preventDefault(); // Prevent traditional form submission

    // Check if all slots are filled
    const filledSlots = Object.values(fileSlots).filter(slot => slot.file !== null).length;
    if (filledSlots !== 3) {
        showError("Please upload exactly 3 audio files for analysis");
        return;
    }

    // Show loading state
    submitBtn.style.display = "none";
    loadingState.style.display = "block";
    clearAllBtn.style.display = "none";

    try {
        // Create FormData for file upload
        const formData = new FormData();
        Object.values(fileSlots).forEach(slot => {
            if (slot.file) {
                formData.append('audio_files', slot.file);
            }
        });

        // Submit to server
        const response = await fetch('{{ url_for("backend.classify") }}', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const html = await response.text();

            // Extract result and confidence from HTML response
            const resultMatch = html.match(/<p class="result-text">([^<]+)<\/p>/);
            const confidenceMatch = html.match(/<span class="confidence-text">([^<]+)<\/span>/);

            if (resultMatch) {
                const result = resultMatch[1];
                const confidence = confidenceMatch ? confidenceMatch[1] : "85%";

                // Handle successful analysis
                await handleAnalysisSuccess(result, confidence);

                // Update the page content with the result
                const resultSection = document.getElementById("resultSection");
                if (resultSection) {
                    resultSection.remove();
                }

                // Create new result section
                const newResultSection = document.createElement("div");
                newResultSection.className = "result-section";
                newResultSection.id = "resultSection";

                const resultClass = result.toLowerCase().includes('mature') ? 'mature' :
                                  result.toLowerCase().includes('premature') ? 'premature' : 'overmature';

                newResultSection.innerHTML = `
                    <div class="result-box ${resultClass}">
                        <div class="result-header">
                            <div class="result-icon">
                                ${resultClass === 'mature' ? 'üå¥' : resultClass === 'premature' ? 'üå±' : 'üçÇ'}
                            </div>
                            <h3>Classification Result</h3>
                        </div>
                        <div class="result-content">
                            <p class="result-text">${result}</p>
                            <div class="confidence-meter">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${confidence.replace('%', '')}%"></div>
                                </div>
                                <span class="confidence-text">${confidence}</span>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn btn--primary" onclick="scrollToUpload()">Analyze Another</button>
                        </div>
                    </div>
                `;

                // Insert result section inside upload box at bottom
                const uploadBox = document.querySelector(".upload-box");
                uploadBox.appendChild(newResultSection);

                // Scroll to result
                setTimeout(() => {
                    newResultSection.scrollIntoView({
                        behavior: "smooth",
                        block: "center"
                    });
                }, 100);

            } else {
                showError("Analysis completed but couldn't parse result");
            }
        } else {
            showError("Analysis failed. Please try again.");
        }

    } catch (error) {
        console.error('Error during analysis:', error);
        showError("Network error. Please check your connection and try again.");
    } finally {
        // Hide loading state
        loadingState.style.display = "none";
        submitBtn.style.display = "inline-block";
        clearAllBtn.style.display = "inline-block";

        // Clear all file inputs after analysis completion (success or failure)
        clearAllBtn.click();
    }
});

// Handle successful analysis and store in IndexedDB
async function handleAnalysisSuccess(result, confidence) {
    try {
        // Create analysis entry
        const filenames = Object.values(fileSlots)
            .filter(slot => slot.file)
            .map(slot => slot.file.name);

        const analysisEntry = {
            id: Date.now(), // Use timestamp as unique ID
            filename: filenames.join(" + "),
            files: filenames,
            result: result,
            confidence: parseFloat(confidence.replace('%', '')),
            timestamp: new Date().toISOString(),
            filepaths: Object.values(fileSlots)
                .filter(slot => slot.file)
                .map(slot => `uploads/${slot.file.name}`)
        };

        // Store in IndexedDB
        await analysisDB.addAnalysis(analysisEntry);

        // Immediately update recent analyses display with the new analysis
        updateRecentAnalysesWithNewAnalysis(analysisEntry);

        // Show success message
        showSuccess("Analysis completed and saved to history!");

    } catch (error) {
        console.error('Error storing analysis:', error);
        showError("Analysis completed but failed to save to history");
    }
}

// Success message display function
function showSuccess(message) {
    const successDiv = document.createElement("div");
    successDiv.className = "success-message";
    successDiv.textContent = message;
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(successDiv);

    setTimeout(() => {
        successDiv.remove();
    }, 5000);
}

// Error display function
function showError(message) {
    const errorDiv = document.createElement("div");
    errorDiv.className = "error-message";
    errorDiv.textContent = message;
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #e74c3c;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(errorDiv);

    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Scroll to upload section
function scrollToUpload() {
    const uploadSection = document.querySelector(".upload-section");
    if (uploadSection) {
        uploadSection.scrollIntoView({
            behavior: "smooth",
            block: "start"
        });
    }
}

// Load recent analyses from IndexedDB
async function loadRecentAnalyses() {
    try {
        const recentAnalyses = await analysisDB.getRecentAnalyses(5);

        const recentAnalysesList = document.getElementById('recentAnalysesList');
        const noAnalyses = document.getElementById('noAnalyses');

        if (recentAnalyses.length === 0) {
            noAnalyses.style.display = 'block';
            return;
        }

        noAnalyses.style.display = 'none';

        recentAnalysesList.innerHTML = recentAnalyses.map(analysis => createRecentAnalysisItem(analysis)).join('');
    } catch (error) {
        console.error('Error loading recent analyses:', error);
        // Fallback to server API
        try {
            const response = await fetch('/backend/api/history/recent?limit=5');
            const recentAnalyses = await response.json();

            const recentAnalysesList = document.getElementById('recentAnalysesList');
            const noAnalyses = document.getElementById('noAnalyses');

            if (recentAnalyses.length === 0) {
                noAnalyses.style.display = 'block';
                return;
            }

            noAnalyses.style.display = 'none';

            recentAnalysesList.innerHTML = recentAnalyses.map(analysis => createRecentAnalysisItem(analysis)).join('');
        } catch (fallbackError) {
            console.error('Error in fallback loading:', fallbackError);
        }
    }
}

// Create recent analysis item HTML
function createRecentAnalysisItem(analysis) {
    const timestamp = new Date(analysis.timestamp);
    const timeAgo = formatTimeAgo(timestamp);
    const resultClass = analysis.result.toLowerCase().includes('overmature') ? 'overmature' :
                      analysis.result.toLowerCase().includes('premature') ? 'premature' :
                      analysis.result.toLowerCase().includes('mature') ? 'mature' : 'overmature';

    return `
        <div class="analysis-item">
            <div class="analysis-filename">${analysis.filename}</div>
            <div class="analysis-result-text ${resultClass}">${analysis.result}</div>
            <div class="analysis-confidence">${analysis.confidence}%</div>
            <div class="analysis-time">${timeAgo}</div>
        </div>
    `;
}

// Format time ago
function formatTimeAgo(date) {
    const now = new Date();
    const diff = now - date;

    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (minutes < 1) return "Just now";
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
}

// Immediately update recent analyses with new analysis
function updateRecentAnalysesWithNewAnalysis(analysis) {
    const recentAnalysesList = document.getElementById('recentAnalysesList');
    const noAnalyses = document.getElementById('noAnalyses');

    // Hide "no analyses" message if it's showing
    if (noAnalyses) {
        noAnalyses.style.display = 'none';
    }

    // Create the new analysis item HTML
    const newAnalysisItem = createRecentAnalysisItem(analysis);

    // Insert the new analysis at the beginning of the list
    if (recentAnalysesList.children.length > 0) {
        // Insert before the first child
        recentAnalysesList.insertAdjacentHTML('afterbegin', newAnalysisItem);
    } else {
        // If no existing analyses, just set the innerHTML
        recentAnalysesList.innerHTML = newAnalysisItem;
    }

    // Keep only the 5 most recent analyses
    while (recentAnalysesList.children.length > 5) {
        recentAnalysesList.removeChild(recentAnalysesList.lastChild);
    }
}

// IndexedDB setup and management
class AnalysisDB {
    constructor() {
        this.dbName = 'CoconutAnalysisDB';
        this.dbVersion = 1;
        this.storeName = 'analyses';
        this.db = null;
    }

    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);

            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const store = db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('filename', 'filename', { unique: false });
                }
            };
        });
    }

    async addAnalysis(analysis) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);

            const analysisWithMeta = {
                ...analysis,
                timestamp: new Date().toISOString(),
                synced: false
            };

            const request = store.add(analysisWithMeta);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async getAllAnalyses() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async getRecentAnalyses(limit = 5) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const index = store.index('timestamp');
            const request = index.openCursor(null, 'prev'); // Most recent first

            const results = [];
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && results.length < limit) {
                    results.push(cursor.value);
                    cursor.continue();
                } else {
                    resolve(results);
                }
            };
            request.onerror = () => reject(request.error);
        });
    }

    async deleteAnalysis(id) {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.delete(id);

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async clearAllAnalyses() {
        if (!this.db) await this.init();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.clear();

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }


}

// Global database instance
const analysisDB = new AnalysisDB();

// Load recent analyses when page loads
document.addEventListener("DOMContentLoaded", async function() {
    try {
        // Initialize database
        await analysisDB.init();

        // Load recent analyses from local storage only
        await loadRecentAnalyses();

        // Scroll to results if present
        setTimeout(function() {
            const resultSection = document.getElementById("resultSection");
            if (resultSection) {
                resultSection.scrollIntoView({
                    behavior: "smooth",
                    block: "center"
                });
            }
        }, 100);
    } catch (error) {
        console.error('Error initializing app:', error);
        // Show empty state if IndexedDB fails
        const recentAnalysesList = document.getElementById('recentAnalysesList');
        const noAnalyses = document.getElementById('noAnalyses');
        if (recentAnalysesList && noAnalyses) {
            noAnalyses.style.display = 'block';
        }
    }
});
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>
{% endblock %}
